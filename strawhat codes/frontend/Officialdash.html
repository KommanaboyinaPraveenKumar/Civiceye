<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Official Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <style>
    :root {
      --bg: #2C2F33; 
      --card: #2C2F33; 
      --muted: #94a3b8;
      --text: #FFF085; 
      --accent: #22c55e;
      --danger: #ef4444;
      --brand: #60a5fa;
      --border: #1f2937;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #2C2F33, #1a1d21 100%);
      color: var(--text);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(180deg, #2C2F33, #1a1d21);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 1px 0 rgba(255,255,255,0.04) inset, 0 8px 30px rgba(2,6,23,0.4);
    }

    .dashboard-header h2 {
      color: var(--text);
      margin: 0;
      font-size: 24px;
      font-weight: 700;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .profile {
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: background-color 0.2s ease;
    }

    .profile:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .profile img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }

    .btn {
      background: #2C2F33;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .btn:hover {
      background: #374151;
      transform: translateY(-1px);
    }

    .btn-logout {
      background: var(--danger);
      border-color: #dc2626;
      color: white;
    }

    .btn-logout:hover {
      background: #dc2626;
    }

    .btn-primary {
      background: var(--accent);
      border-color: #16a34a;
      color: #052e16;
    }

    .btn-primary:hover {
      background: #16a34a;
    }

    .btn-secondary {
      background: #6b7280;
      border-color: #4b5563;
      color: white;
    }

    .user-info-card {
      background: linear-gradient(180deg, #2C2F33, #1a1d21);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 0 rgba(255,255,255,0.04) inset, 0 8px 30px rgba(2,6,23,0.4);
    }

    .user-info-card h3 {
      color: var(--text);
      margin: 0 0 8px 0;
      font-size: 20px;
    }

    .muted {
      color: var(--muted);
      font-size: 14px;
    }

    .official-details {
      margin-top: 16px;
      padding: 16px;
      background: #374151;
      border-radius: 10px;
      border: 1px solid #fbbf24;
    }

    .official-details p {
      margin: 8px 0;
      color: #ffffff;
      font-size: 14px;
    }

    .official-details strong {
      color: #fbbf24;
    }

    .official-controls {
      background: linear-gradient(180deg, #2C2F33, #1a1d21);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 24px;
      margin-bottom: 24px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 20px;
      align-items: end;
      box-shadow: 0 1px 0 rgba(255,255,255,0.04) inset, 0 8px 30px rgba(2,6,23,0.4);
    }

    .filters, .sorts {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .filters label, .sorts label {
      color: var(--text);
      font-weight: 600;
      font-size: 14px;
    }

    .filters select, .sorts select {
      background: #374151;
      color: #ffffff;
      border: 1px solid #4b5563;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 14px;
    }

    .filters {
      display: flex;
      flex-direction: row;
      align-items: end;
      gap: 12px;
    }

    .top-liked-section {
      text-align: center;
      margin-bottom: 24px;
    }

    .grid-heading {
      color: var(--text);
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 20px;
    }

    .posts-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 20px;
    }

    @media (max-width: 1024px) { 
      .posts-grid { grid-template-columns: repeat(2, 1fr); } 
    }
    
    @media (max-width: 640px) { 
      .posts-grid { grid-template-columns: 1fr; }
      .official-controls {
        grid-template-columns: 1fr;
      }
      .filters {
        flex-direction: column;
        align-items: stretch;
      }
    }

    .product-card {
      background: linear-gradient(180deg, #1a1d21, #111318);
      border: 1px solid #0f1419;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 1px 0 rgba(255,255,255,0.02) inset, 0 8px 30px rgba(0,0,0,0.6);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .product-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 1px 0 rgba(255,255,255,0.04) inset, 0 12px 40px rgba(0,0,0,0.8);
    }

    .product-card.status-new {
      background: linear-gradient(180deg, #1a1d21, #111318);
      border-color: #0f1419;
    }

    .product-card.status-in_progress {
      background: linear-gradient(180deg, #2C2F33, #1a1d21);
      border: 2px solid #fbbf24;
      box-shadow: 0 0 0 1px #fbbf24, 0 8px 30px rgba(251, 191, 36, 0.3);
    }

    .product-card.status-in_progress:hover {
      box-shadow: 0 0 0 2px #f59e0b, 0 12px 40px rgba(251, 191, 36, 0.4);
    }

    .product-card.status-solved {
      background: linear-gradient(180deg, #064e3b, #052e16);
      border: 2px solid #22c55e;
      box-shadow: 0 0 0 1px #22c55e, 0 8px 30px rgba(34, 197, 94, 0.3);
    }

    .product-card.status-solved:hover {
      box-shadow: 0 0 0 2px #16a34a, 0 12px 40px rgba(34, 197, 94, 0.4);
    }

    .thumb {
      display: grid;
      place-items: center;
      background: #2C2F33;
      padding: 12px;
    }

    .thumb img {
      width: 100%;
      height: 220px;
      object-fit: cover;
      border-radius: 10px;
      background: #374151;
    }

    .pc-body {
      padding: 16px;
    }

    .pc-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      margin: 0 0 12px;
      line-height: 1.4;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .pc-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .pc-row.rating {
      color: #f59e0b;
      font-size: 14px;
    }

    .pc-row.rating .count {
      color: var(--muted);
      font-size: 14px;
      font-weight: 600;
    }

    .pc-row.meta {
      flex-wrap: wrap;
    }

    .chip {
      background: #374151;
      color: var(--muted);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      border: 1px solid #4b5563;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-new {
      background: #374151;
      color: #d1d5db;
      border: 1px solid #4b5563;
    }

    .badge-in_progress {
      background: #ffedd5;
      color: #9a3412;
      border: 1px solid #fb923c;
    }

    .badge-solved {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #22c55e;
    }

    .pc-row.subtle {
      color: var(--muted);
      font-size: 12px;
      margin-top: 8px;
    }

    .stars {
      color: #f59e0b;
      font-size: 16px;
    }

    .progress-tick {
      color: var(--accent);
      font-size: 18px;
      margin-left: auto;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .empty {
      text-align: center;
      color: var(--muted);
      padding: 60px 20px;
      border: 2px dashed var(--border);
      border-radius: 14px;
      background: linear-gradient(180deg, #2C2F33, #1a1d21);
      font-size: 16px;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: linear-gradient(180deg, #2C2F33, #1a1d21);
      border: 1px solid var(--border);
      padding: 30px;
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }

    .close {
      position: absolute;
      top: 20px;
      right: 25px;
      font-size: 28px;
      cursor: pointer;
      color: var(--muted);
      font-weight: bold;
    }

    .close:hover {
      color: var(--text);
    }

    .profile-header {
      text-align: center;
      margin-bottom: 24px;
    }

    .profile-header h3 {
      color: var(--text);
      margin: 12px 0 0 0;
    }

    .profile-details p {
      margin: 12px 0;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      color: var(--text);
    }

    .profile-details p:last-child {
      border-bottom: none;
    }

    .modal-actions {
      margin-top: 24px;
      text-align: center;
    }

    .status-update {
      margin-top: 20px;
      padding: 16px;
      background: #374151;
      border-radius: 10px;
      border-left: 4px solid var(--brand);
    }

    .status-update h4 {
      margin: 0 0 12px 0;
      color: var(--text);
    }

    .status-update select {
      background: #2C2F33;
      color: var(--text);
      border: 1px solid var(--border);
      padding: 10px 12px;
      border-radius: 8px;
      width: 100%;
      font-size: 14px;
    }

    .post-detail-header img {
      width: 100%;
      max-height: 300px;
      object-fit: cover;
      border-radius: 12px;
      margin-bottom: 16px;
    }

    .post-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin: 16px 0;
      color: var(--muted);
      font-size: 14px;
    }

    .post-meta span {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-summary-inline {
      margin-top: 20px;
      padding: 16px;
      background: #374151;
      border-radius: 10px;
      border-left: 4px solid var(--brand);
    }

    .status-summary-inline h4 {
      margin: 0 0 12px 0;
      color: var(--text);
    }

    .status-summary-inline ul {
      margin: 0;
      padding-left: 20px;
      color: var(--text);
    }

    .status-summary-inline li {
      margin: 6px 0;
      font-size: 14px;
    }

    .tracking-timeline {
      margin: 20px 0;
    }

    .timeline-item {
      display: flex;
      align-items: flex-start;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .timeline-item.active {
      opacity: 1;
    }

    .timeline-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #4b5563;
      margin-right: 16px;
      margin-top: 4px;
      flex-shrink: 0;
    }

    .timeline-item.active .timeline-dot {
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
    }

    .timeline-content h4 {
      margin: 0 0 4px 0;
      color: var(--text);
    }

    .timeline-content p {
      margin: 0 0 4px 0;
      color: var(--muted);
      font-size: 14px;
    }

    .timeline-content .time {
      font-size: 12px;
      color: var(--muted);
      font-style: italic;
    }

    .tracking-stats {
      background: #374151;
      padding: 16px;
      border-radius: 10px;
      margin: 20px 0;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #4b5563;
      color: var(--text);
    }

    .stat-item:last-child {
      border-bottom: none;
    }

    .status-new { color: var(--muted); }
    .status-in_progress { color: #f59e0b; }
    .status-solved { color: var(--accent); }

    .resolution-images {
      margin-top: 20px;
    }

    .image-comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 12px;
    }

    .image-comparison h5 {
      margin: 0 0 8px 0;
      text-align: center;
      color: var(--text);
    }

    .image-comparison img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    </style>
</head>
<body>
  <div class="container">
    <div class="dashboard-section" id="officialDashboard">
      <div class="dashboard-header">
        <h2><i class="fas fa-user-tie"></i> Government Official Dashboard</h2>
        <div class="header-actions">
          <div class="profile" onclick="openProfileModal()">
            <img id="profileAvatar" src="https://api.dicebear.com/7.x/bottts/png?seed=official&size=64&backgroundColor=b6e3f4" alt="Profile"/>
          </div>
          <button class="btn btn-logout" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>
      </div>

      <div class="dashboard-content">
        <div class="user-info-card">
          <h3>Welcome, <span id="officialName">Loading...</span>!</h3>
          <p class="muted">Manage citizen requests across your department.</p>
          <div class="official-details">
            <p><strong>Designation:</strong> <span id="officialDesignation">Loading...</span></p>
            <p><strong>Department:</strong> <span id="officialDepartment">Loading...</span></p>
          </div>
        </div>

        <div class="official-controls">
          <div class="filters">
            <label for="tagFilter">Filter by Department/Tag</label>
            <select id="tagFilter">
              <option value="all">All</option>
              <option value="electricity">Electricity</option>
              <option value="road">Road</option>
              <option value="municipality">Municipality</option>
              <option value="water">Water</option>
              <option value="health">Health</option>
              <option value="education">Education</option>
              <option value="police">Police</option>
            </select>
            <button class="btn" onclick="applyFilter()">Apply Filter</button>
            <button class="btn btn-secondary" onclick="clearFilter()">Clear Filter</button>
          </div>
          <div class="sorts">
            <label for="sortBy">Sort by</label>
            <select id="sortBy" onchange="renderPosts()">
              <option value="recent">Most Recent</option>
              <option value="likes">Most Liked</option>
              <option value="unresolved">Unresolved First</option>
            </select>
          </div>
        </div>

        <div class="top-liked-section">
          <button class="btn btn-primary" onclick="toggleTopLiked()">
            <i class="fas fa-thumbs-up"></i> Top Most Liked
          </button>
        </div>

        <h3 class="grid-heading">Citizen Reports</h3>
        <section class="posts-grid" id="postsList"></section>
      </div>
    </div>
  </div>

  <div id="profileModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeProfileModal()">&times;</span>
      <div class="profile-header">
        <img id="profileModalAvatar" src="https://api.dicebear.com/7.x/bottts/png?seed=official&size=100&backgroundColor=b6e3f4" alt="Profile" style="width: 100px; height: 100px; border-radius: 50%; margin-bottom: 20px;">
        <h3>Official Profile</h3>
      </div>
      <div class="profile-details" id="profileDetails">
        <p><strong>Name:</strong> <span id="profileName">Loading...</span></p>
        <p><strong>Designation:</strong> <span id="profileDesignation">Loading...</span></p>
        <p><strong>Department:</strong> <span id="profileDepartment">Loading...</span></p>
        <p><strong>Posts Solved:</strong> <span id="postsSolvedCount">0</span></p>
        <p><strong>Email:</strong> <span id="profileEmail">Loading...</span></p>
        <p><strong>Phone:</strong> <span id="profilePhone">Loading...</span></p>
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="logout()">Logout</button>
      </div>
    </div>
  </div>

  <div id="postModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closePostModal()">&times;</span>
      <div id="postDetail"></div>
      <div class="status-update">
        <h4>Update Status</h4>
        <select id="postStatusSelect" onchange="handleStatusChange()">
          <option value="new">New</option>
          <option value="in_progress">In Progress</option>
          <option value="solved">Solved</option>
        </select>
      </div>
      <div class="modal-actions" id="postActions"></div>
    </div>
  </div>

  <div id="resolutionModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeResolutionModal()">&times;</span>
      <h3>Mark as Solved</h3>
      <p>Upload a picture of the completed work:</p>
      <input type="file" id="resolutionImage" accept="image/*" required style="background: #374151; color: var(--text); border: 1px solid var(--border); padding: 10px; border-radius: 8px; width: 100%;">
      <div class="modal-actions">
        <button type="button" class="btn" onclick="closeResolutionModal()">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitResolution()">Submit Resolution</button>
      </div>
    </div>
  </div>

  <div id="trackingModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeTrackingModal()">&times;</span>
      <h3>Post Tracking</h3>
      <div id="trackingContent"></div>
      <div class="modal-actions">
        <button type="button" class="btn" onclick="closeTrackingModal()">Close</button>
      </div>
    </div>
  </div>

  <div id="progressModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeProgressModal()">&times;</span>
      <h3>Update Status</h3>
      <p>This work is now in progress and will be completed in <strong>10 working days</strong>.</p>
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="updatePostProgress('in_progress')">Confirm</button>
        <button class="btn" onclick="closeProgressModal()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3000/api';
    const API_ORIGIN = API_BASE.replace(/\/api$/, '');

    function escapeHtml(text) {
      return (text || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function computeStatus(p) {
      if (p.citizenConfirmed || (p.resolution && p.resolution.afterImage)) return 'solved';
      if (p.resolution && p.resolution.awaitingCitizenConfirmation) return 'in_progress';
      return 'new';
    }

    function timeAgo(date) {
      const now = new Date();
      const seconds = Math.floor((now - new Date(date)) / 1000);
      let interval = Math.floor(seconds / 31536000);
      if (interval >= 1) return interval + ' year' + (interval === 1 ? '' : 's') + ' ago';
      interval = Math.floor(seconds / 2592000);
      if (interval >= 1) return interval + ' month' + (interval === 1 ? '' : 's') + ' ago';
      interval = Math.floor(seconds / 86400);
      if (interval >= 1) return interval + ' day' + (interval === 1 ? '' : 's') + ' ago';
      interval = Math.floor(seconds / 3600);
      if (interval >= 1) return interval + ' hour' + (interval === 1 ? '' : 's') + ' ago';
      interval = Math.floor(seconds / 60);
      if (interval >= 1) return interval + ' minute' + (interval === 1 ? '' : 's') + ' ago';
      return 'just now';
    }

    let currentPost = null;
    let resolutionPost = null;
    let currentFilter = 'all';
    let currentSort = 'recent';

    async function getUser() {
      try {
        const token = localStorage.getItem('civiceye_token');
        if (!token) return null;
        const response = await fetch(`${API_BASE}/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          return await response.json();
        } else {
          console.error('Failed to fetch user:', response.status);
          return null;
        }
      } catch (error) {
        console.error('Error fetching user:', error);
        return null;
      }
    }

    async function loadOfficialDetails() {
      try {
        const user = await getUser();
        if (!user) return;
        document.getElementById('officialName').textContent = user.name || 'Official';
        document.getElementById('officialDesignation').textContent = user.designation || user.role || 'Not specified';
        document.getElementById('officialDepartment').textContent = user.department || user.role || 'Not specified';
        document.getElementById('profileName').textContent = user.name || 'Official';
        document.getElementById('profileDesignation').textContent = user.designation || user.role || 'Not specified';
        document.getElementById('profileDepartment').textContent = user.department || user.role || 'Not specified';
        document.getElementById('profileEmail').textContent = user.email || 'Not specified';
        document.getElementById('profilePhone').textContent = user.phone || 'Not specified';
        document.getElementById('postsSolvedCount').textContent = user.postsSolved || 0;
        console.log('Official details loaded:', user);
      } catch (error) {
        console.error('Failed to load official details:', error);
      }
    }

    function starsHtml(rating) {
      const full = '★'.repeat(rating);
      const empty = '☆'.repeat(5 - rating);
      return `<span class="stars">${full}${empty}</span>`;
    }

    function applyFilter() {
      currentFilter = document.getElementById('tagFilter').value;
      console.log('Filter applied:', currentFilter);
      renderPosts();
    }

    function clearFilter() {
      document.getElementById('tagFilter').value = 'all';
      currentFilter = 'all';
      console.log('Filter cleared');
      renderPosts();
    }

    function toggleTopLiked() {
      currentSort = 'likes';
      document.getElementById('sortBy').value = 'likes';
      renderPosts();
    }

    async function updatePostProgress(newStatus) {
      if (!currentPost) return;
      try {
        let endpoint;
        let body = {};
        if (newStatus === 'in_progress') {
          endpoint = `/posts/${currentPost._id}/mark-progress`;
        } else if (newStatus === 'solved') {
          resolutionPost = currentPost;
          closePostModal();
          document.getElementById('resolutionModal').classList.add('show');
          return;
        } else {
          endpoint = `/posts/${currentPost._id}/reset`;
        }
        const response = await fetch(`${API_BASE}${endpoint}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('civiceye_token')}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });
        if (response.ok) {
          alert(`Post marked as ${newStatus.replace('_', ' ')}!`);
          closePostModal();
          closeProgressModal();
          await renderPosts();
        } else {
          throw new Error('Failed to update status');
        }
      } catch (error) {
        console.error('Error:', error);
        alert(`Failed to update status: ${error.message}`);
      }
    }

    async function submitResolution() {
      const file = document.getElementById('resolutionImage').files[0];
      if (!file) {
        alert('Please upload an image of the completed work.');
        return;
      }
      if (!resolutionPost) {
        alert('Error: No post selected for resolution.');
        return;
      }
      try {
        const formData = new FormData();
        formData.append('afterImage', file);
        formData.append('postId', resolutionPost._id);
        const res = await fetch(`${API_BASE}/posts/${resolutionPost._id}/resolve`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${localStorage.getItem('civiceye_token')}` },
          body: formData
        });
        let responseData;
        try {
          responseData = await res.json();
        } catch (err) {
          const text = await res.text();
          throw new Error('Unexpected server response (not JSON):\n' + text.slice(0, 300));
        }
        console.log('Resolution response:', responseData);
        if (!res.ok) throw new Error(responseData.message || 'Failed to submit resolution');
        alert('Resolution submitted successfully!');
        closeResolutionModal();
        if (currentPost && currentPost._id === resolutionPost._id) {
          currentPost = responseData.post || currentPost;
        }
        await renderPosts();
      } catch (error) {
        console.error('Resolution error:', error);
        alert('Failed to submit resolution: ' + error.message);
      }
    }

    function handleStatusChange() {
      const newStatus = document.getElementById('postStatusSelect').value;
      if (newStatus === 'in_progress') {
        document.getElementById('progressModal').classList.add('show');
      } else if (newStatus === 'solved') {
        updatePostProgress('solved');
      } else {
        updatePostProgress(newStatus);
      }
    }

    function showPostTracking(post) {
      const trackingContent = document.getElementById('trackingContent');
      const status = computeStatus(post);
      console.log('Post status:', status, 'Resolution:', post.resolution);
      let trackingHtml = `
        <div class="tracking-timeline">
          <div class="timeline-item ${status === 'new' ? 'active' : ''}">
            <div class="timeline-dot"></div>
            <div class="timeline-content">
              <h4>Post Created</h4>
              <p>Citizen reported issue on ${new Date(post.createdAt).toLocaleDateString()}</p>
              <span class="time">${timeAgo(post.createdAt)}</span>
            </div>
          </div>
          <div class="timeline-item ${status === 'in_progress' || status === 'solved' ? 'active' : ''}">
            <div class="timeline-dot"></div>
            <div class="timeline-content">
              <h4>In Progress</h4>
              <p>Official marked work as in progress</p>
              <span class="time">${post.resolution?.awaitingCitizenConfirmation ? 'Recently updated' : 'Not started'}</span>
            </div>
          </div>
          <div class="timeline-item ${status === 'solved' ? 'active' : ''}">
            <div class="timeline-dot"></div>
            <div class="timeline-content">
              <h4>Completed</h4>
              <p>Work finished and resolution submitted</p>
              <span class="time">${post.resolution?.afterImage ? 'Recently completed' : 'Pending'}</span>
            </div>
          </div>
        </div>
        <div class="tracking-stats">
          <div class="stat-item">
            <strong>Current Status:</strong> <span class="status-${status}">${status.replace('_', ' ')}</span>
          </div>
          <div class="stat-item">
            <strong>Views:</strong> ${typeof post.views === 'number' ? post.views : 0}
          </div>
          <div class="stat-item">
            <strong>Score:</strong> ${typeof post.score === 'number' ? post.score : 0}
          </div>
          <div class="stat-item">
            <strong>Authority Viewed:</strong> ${post.authorityViewed ? 'Yes' : 'No'}
          </div>
        </div>
      `;
      if (post.resolution?.afterImage) {
        const afterImageUrl = post.resolution.afterImage.startsWith('/')
          ? `${API_ORIGIN}${post.resolution.afterImage}`
          : `${API_ORIGIN}/images/${post.resolution.afterImage}`;
        console.log('Resolution image URL:', afterImageUrl);
        trackingHtml += `
          <div class="resolution-images">
            <h4>Resolution Images</h4>
            <div class="image-comparison">
              <div>
                <h5>Before</h5>
                <img src="${API_ORIGIN}${post.image || '/images/download.jpg'}" alt="Before" />
              </div>
              <div>
                <h5>After</h5>
                <img src="${afterImageUrl}" alt="After" onerror="this.src='${API_ORIGIN}/images/download.jpg'" />
              </div>
            </div>
          </div>
        `;
      }
      trackingContent.innerHTML = trackingHtml;
      document.getElementById("trackingModal").classList.add('show');
    }

    function openPostDetail(post) {
      currentPost = post;
      const detail = document.getElementById('postDetail');
      const actions = document.getElementById('postActions');
      const statusSelect = document.getElementById('postStatusSelect');
      const status = computeStatus(post);
      detail.innerHTML = `
        <div class="post-detail-header">
          <img src="${post.image ? API_ORIGIN + post.image : API_ORIGIN + '/images/download.jpg'}" 
               alt="Post image" />
        </div>
        <h3>${escapeHtml(post.description)}</h3>
        <div class="post-meta">
          <span><i class="fa fa-location-dot"></i> ${escapeHtml(post.location || '')}</span>
          <span><i class="fa fa-tag"></i> ${(post.officials && post.officials.length) ? post.officials.join(', ') : 'general'}</span>
          <span><i class="fa fa-thumbs-up"></i> ${typeof post.score === 'number' ? post.score : 0}</span>
          <span><i class="fa fa-clock"></i> ${timeAgo(post.createdAt)}</span>
        </div>
        <div class="status-summary-inline">
          <h4>Status Summary</h4>
          <ul>
            <li><strong>Current Status:</strong> ${status.replace('_', ' ')}</li>
            <li><strong>Views:</strong> ${typeof post.views === 'number' ? post.views : 0}</li>
            <li><strong>Score:</strong> ${typeof post.score === 'number' ? post.score : 0}</li>
          </ul>
        </div>
        ${post.resolution?.afterImage ? `
          <div class="resolution-images">
            <h4>Resolution Images</h4>
            <div class="image-comparison">
              <div>
                <h5>Before</h5>
                <img src="${API_ORIGIN}${post.image || '/images/download.jpg'}" alt="Before" />
              </div>
              <div>
                <h5>After</h5>
                <img src="${post.resolution.afterImage.startsWith('/') ? API_ORIGIN + post.resolution.afterImage : API_ORIGIN + '/images/' + post.resolution.afterImage}" alt="After" onerror="this.src='${API_ORIGIN}/images/download.jpg'" />
              </div>
            </div>
          </div>
        ` : ''}
      `;
      statusSelect.value = status;
      actions.innerHTML = `
        <button class="btn btn-secondary" onclick="showPostTracking(${JSON.stringify(post).replace(/"/g, '&quot;')})">
          <i class="fa fa-eye"></i> View Progress
        </button>
      `;
      document.getElementById('postModal').classList.add('show');
    }

    function closePostModal() { 
      document.getElementById("postModal").classList.remove('show'); 
      currentPost = null;
    }

    function closeProgressModal() { 
      document.getElementById("progressModal").classList.remove('show'); 
    }

    function closeResolutionModal() { 
      document.getElementById("resolutionModal").classList.remove('show');
      document.getElementById('resolutionImage').value = '';
      resolutionPost = null;
    }

    function closeTrackingModal() { 
      document.getElementById("trackingModal").classList.remove('show'); 
    }

    function openProfileModal() { 
      document.getElementById("profileModal").classList.add('show'); 
    }

    function closeProfileModal() { 
      document.getElementById("profileModal").classList.remove('show'); 
    }

    function NumericalSort(a, b) {
      return a > b ? -1 : a < b ? 1 : 0;
    }

    async function renderPosts() {
      const postsList = document.getElementById('postsList');
      postsList.innerHTML = '';
      try {
        const res = await fetch(`${API_BASE}/posts?cacheBust=${Date.now()}`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('civiceye_token')}` }
        });
        if (!res.ok) throw new Error(await res.text());
        const posts = await res.json();
        console.log('Fetched posts:', posts);
        if (!Array.isArray(posts) || posts.length === 0) {
          postsList.innerHTML = '<div class="empty">No posts yet.</div>';
          return;
        }
        let filteredPosts = posts;
        if (currentFilter !== 'all') {
          filteredPosts = posts.filter(p => {
            const officials = p.officials || [];
            return officials.some(official => 
              official.toLowerCase().includes(currentFilter.toLowerCase())
            );
          });
        }
        if (currentSort === 'recent') {
          filteredPosts.sort((a, b) => NumericalSort(new Date(b.createdAt), new Date(a.createdAt)));
        } else if (currentSort === 'likes') {
          filteredPosts.sort((a, b) => NumericalSort((b.score || 0), (a.score || 0)));
        } else if (currentSort === 'unresolved') {
          filteredPosts.sort((a, b) => {
            const aStatus = computeStatus(a);
            const bStatus = computeStatus(b);
            if (aStatus === 'new' && bStatus !== 'new') return -1;
            if (aStatus === 'in_progress' && bStatus === 'solved') return -1;
            return 0;
          });
        }
        if (filteredPosts.length === 0) {
          postsList.innerHTML = '<div class="empty">No posts match the selected filter.</div>';
          return;
        }
        const html = filteredPosts.map(p => {
          const status = computeStatus(p);
          const badgeClass = status === 'solved' ? 'badge-solved' : status === 'in_progress' ? 'badge-in_progress' : 'badge-new';
          const imageUrl = p.image ? `${API_ORIGIN}${p.image}` : `${API_ORIGIN}/images/download.jpg`;
          const tag = (p.officials && p.officials.length) ? p.officials[0] : 'general';
          const rating = Math.min(5, Math.max(1, Math.round(((p.score || 0) % 10) / 2)));
          const hasProgress = status === 'in_progress' || status === 'solved';
          return `
            <article class="product-card status-${status}" onclick="openPostDetail(${JSON.stringify(p).replace(/"/g, '&quot;')})" style="cursor: pointer;">
              <div class="thumb">
                <img src="${imageUrl}" alt="Post image" onerror="this.src='${API_ORIGIN}/images/download.jpg'" />
              </div>
              <div class="pc-body">
                <h4 class="pc-title">${escapeHtml(p.description)}</h4>
                <div class="pc-row rating">
                  ${starsHtml(rating)}
                  <span class="count">${typeof p.score === 'number' ? p.score : 0}</span>
                  ${hasProgress ? '<span class="progress-tick">✅</span>' : ''}
                </div>
                <div class="pc-row meta">
                  <span class="chip">${escapeHtml(tag)}</span>
                  <span class="chip">${escapeHtml(p.location || '')}</span>
                  <span class="badge ${badgeClass}">${status.replace('_',' ')}</span>
                </div>
                <div class="pc-row subtle">${timeAgo(p.createdAt)}</div>
              </div>
            </article>
          `;
        }).join('');
        postsList.innerHTML = html;
      } catch (e) {
        postsList.innerHTML = '<div class="empty">Failed to load posts.</div>';
        console.error('Official posts load error:', e);
      }
    }

    function logout() {
      localStorage.removeItem('civiceye_token');
      localStorage.removeItem('civiceye_user_v1');
      localStorage.removeItem('civiceye_userId');
      window.location.href = 'index.html';
    }

    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal') && e.target.classList.contains('show')) {
        e.target.classList.remove('show');
        if (e.target.id === 'postModal') {
          currentPost = null;
        } else if (e.target.id === 'resolutionModal') {
          document.getElementById('resolutionImage').value = '';
          resolutionPost = null;
        }
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      loadOfficialDetails();
      renderPosts();
    });
  </script>
</body>
</html>
